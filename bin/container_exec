#!/bin/bash

app_dir=`pwd`
prj_file="$app_dir/project.json"

path=`jq -r ".path" "$prj_file"`
repo=`jq -r ".docker.repo" "$prj_file"`
project=`jq -r ".docker.name" "$prj_file"`


SOCK=/tmp/.X11-unix
XAUTH=/tmp/.docker.xauth-n
xauth nlist $DISPLAY | sed -e 's/^..../ffff/' | sudo xauth -f $XAUTH nmerge -
sudo chmod 777 $XAUTH
X11PORT=`echo $DISPLAY | sed 's/^[^:]*:\([^\.]\+\).*/\1/'`
#TCPPORT=`expr 6000 + $X11PORT`
#sudo ufw allow from 172.17.0.0/16 to any port $TCPPORT proto tcp 
DISPLAY=`echo $DISPLAY | sed 's/^[^:]*\(.*\)/172.17.0.1\1/'`
#sudo docker run -ti --rm -e DISPLAY=$DISPLAY -v $XAUTH:$XAUTH \
#   -e XAUTHORITY=$XAUTH name_of_docker_image
   
#docker run -ti --rm  -p 3100:3100 --net host -v $SOCK:$SOCK -e DISPLAY=$DISPLAY -v $XAUTH:$XAUTH -e XAUTHORITY=$XAUTH -v /dev/shm:/dev/shm -v /vagrant/apps/$path:/code $repo/$project:201902201052 /bin/bash
docker run -ti --rm  -p 3100:3100 --net host -v $SOCK:$SOCK -e DISPLAY=:0.0 -v $XAUTH:$XAUTH -e XAUTHORITY=$XAUTH -v /dev/shm:/dev/shm -v /vagrant/apps/$path:/code $repo/$project:latest /bin/bash
